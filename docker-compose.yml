# =============================================================================
# TelemetryFlow Agent - Docker Compose
# =============================================================================
#
# TelemetryFlow Agent v1.1.2 (Based on OpenTelemetry SDK 1.39.0)
# Community Enterprise Observability Platform (CEOP)
# Copyright (c) 2024-2026 DevOpsCorner Indonesia. All rights reserved.
#
# Features:
#   - OTLP export for metrics, traces, and logs
#   - Dual endpoint support (v1: OTEL standard, v2: TFO Platform)
#   - gRPC and HTTP protocol support
#   - Disk-backed buffer for offline resilience
#
# Usage:
#   # Start with default .env
#   docker-compose up -d
#
#   # Build and start
#   docker-compose up -d --build
#
#   # View logs
#   docker-compose logs -f tfo-agent
#
#   # Stop
#   docker-compose down
#
# =============================================================================

services:
  tfo-agent:
    container_name: ${CONTAINER_NAME:-tfo-agent}
    image: ${IMAGE_NAME:-telemetryflow/telemetryflow-agent}:${IMAGE_TAG:-1.1.2}
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-1.1.2}
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        GIT_BRANCH: ${GIT_BRANCH:-main}
        BUILD_TIME: ${BUILD_TIME:-unknown}
    hostname: ${AGENT_HOSTNAME:-tfo-agent}
    restart: unless-stopped

    # Environment variables
    environment:
      # TelemetryFlow Backend Configuration
      - TELEMETRYFLOW_API_ENDPOINT=${TELEMETRYFLOW_API_ENDPOINT:-http://localhost:3100}
      - TELEMETRYFLOW_API_KEY_ID=${TELEMETRYFLOW_API_KEY_ID:-}
      - TELEMETRYFLOW_API_KEY_SECRET=${TELEMETRYFLOW_API_KEY_SECRET:-}

      # OTLP Collector Connection
      # TFO Collector endpoint (supports both v1 and v2 endpoints)
      - TELEMETRYFLOW_ENDPOINT=${TELEMETRYFLOW_ENDPOINT:-tfo-collector:4317}
      - TELEMETRYFLOW_PROTOCOL=${TELEMETRYFLOW_PROTOCOL:-grpc}

      # Dual Endpoint Version (v1: OTEL standard, v2: TFO Platform)
      - TELEMETRYFLOW_ENDPOINT_VERSION=${TELEMETRYFLOW_ENDPOINT_VERSION:-v2}

      # Signal Type Enablement
      - TELEMETRYFLOW_METRICS_ENABLED=${TELEMETRYFLOW_METRICS_ENABLED:-true}
      - TELEMETRYFLOW_TRACES_ENABLED=${TELEMETRYFLOW_TRACES_ENABLED:-false}
      - TELEMETRYFLOW_LOGS_ENABLED=${TELEMETRYFLOW_LOGS_ENABLED:-false}

      # Logging
      - TELEMETRYFLOW_LOG_LEVEL=${TELEMETRYFLOW_LOG_LEVEL:-info}
      - TELEMETRYFLOW_LOG_FORMAT=${TELEMETRYFLOW_LOG_FORMAT:-json}

      # Legacy (for backward compatibility)
      - COLLECTOR_ENDPOINT=${COLLECTOR_ENDPOINT:-http://tfo-collector:4317}
      - LOG_LEVEL=${LOG_LEVEL:-info}

    # Port mappings
    ports:
      - "${OTLP_GRPC_PORT:-4317}:4317" # OTLP gRPC
      - "${OTLP_HTTP_PORT:-4318}:4318" # OTLP HTTP
      - "${METRICS_PORT:-8888}:8888" # Prometheus metrics
      - "${HEALTH_PORT:-13133}:13133" # Health check

    # Volume mounts
    volumes:
      - ./configs/tfo-agent.yaml:/etc/tfo-agent/tfo-agent.yaml:ro
      - tfo-agent-buffer:/var/lib/tfo-agent
      - tfo-agent-logs:/var/log/tfo-agent

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:13133/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    # Resource limits
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-512M}
          cpus: "${CPU_LIMIT:-0.5}"
        reservations:
          memory: 128M
          cpus: "0.1"

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Network
    networks:
      - telemetryflow

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  tfo-agent-buffer:
    driver: local
  tfo-agent-logs:
    driver: local

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  telemetryflow:
    driver: bridge
    name: telemetryflow-network
